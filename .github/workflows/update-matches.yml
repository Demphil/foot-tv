name: Update Matches Data
on:
  schedule:
    - cron: '0 */6 * * *'  # كل 6 ساعات
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-matches:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'  # تم التعليق أو إزالة هذا السطر إذا لم يكن هناك package-lock.json

      - name: Create Data Directory
        run: |
          mkdir -p data
          touch data/matches.json

      - name: Install Axios Directly
        run: npm install axios --no-package-lock  # حل المشكلة بعدم إنشاء ملف lock

      - name: Fetch Latest Matches
        env:
          RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
        run: |
          node -e "
          const axios = require('axios');
          const fs = require('fs');
          const today = new Date().toISOString().split('T')[0];
          
          async function fetchMatches() {
            try {
              const response = await axios.get(
                'https://api-football-v1.p.rapidapi.com/v3/fixtures',
                {
                  params: { date: today },
                  headers: {
                    'x-rapidapi-host': 'api-football-v1.p.rapidapi.com',
                    'x-rapidapi-key': process.env.RAPIDAPI_KEY
                  }
                }
              );
              
              fs.writeFileSync(
                './data/matches.json',
                JSON.stringify(response.data, null, 2)
              );
              console.log('Data fetched successfully!');
              
            } catch (error) {
              console.error('API Error:', error.message);
              // Generate fallback data
              const fallbackData = {
                response: [
                  {
                    fixture: {
                      id: Math.floor(Math.random() * 10000),
                      date: today,
                      status: { short: 'NS', long: 'Not Started' }
                    },
                    teams: {
                      home: { name: 'Fallback Team A' },
                      away: { name: 'Fallback Team B' }
                    },
                    league: { name: 'Fallback League' }
                  }
                ]
              };
              
              fs.writeFileSync(
                './data/matches.json',
                JSON.stringify(fallbackData, null, 2)
              );
              console.log('Generated fallback data');
            }
          }
          
          fetchMatches();
          "

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

      - name: Commit & Push Changes
        run: |
          git add data/matches.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto-update matches data [skip ci]" && git push)
